name: Crawl Hugging Face Daily Papers

on:
  schedule:
    # ì˜¤ì „ 11ì‹œ (KST) = UTC 02:00
    - cron: '0 2 * * *'
    # ì˜¤í›„ 11ì‹œ (KST) = UTC 14:00
    - cron: '0 14 * * *'
  workflow_dispatch:  # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥

permissions:
  contents: write  # ì»¤ë°‹ ë° í‘¸ì‹œë¥¼ ìœ„í•œ ê¶Œí•œ

jobs:
  crawl:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0  # ì „ì²´ íˆìŠ¤í† ë¦¬ ê°€ì ¸ì˜¤ê¸°
        ref: master  # ëª…ì‹œì ìœ¼ë¡œ master ë¸Œëœì¹˜ ì²´í¬ì•„ì›ƒ
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Run crawler
      run: |
        python scripts/crawl_hf_papers.py
    
    - name: Commit and push changes
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        # ë³€ê²½ëœ íŒŒì¼ í™•ì¸
        echo "=== ë³€ê²½ëœ íŒŒì¼ í™•ì¸ ==="
        git status
        
        # _posts/ì™€ _data/papers/ ë””ë ‰í† ë¦¬ì˜ ë³€ê²½ì‚¬í•­ ì¶”ê°€
        git add _posts/ _data/papers/
        
        # ì¶”ê°€ëœ íŒŒì¼ í™•ì¸
        echo "=== ìŠ¤í…Œì´ì§•ëœ íŒŒì¼ í™•ì¸ ==="
        git diff --staged --name-only
        
        # ë³€ê²½ì‚¬í•­ì´ ìˆì„ ë•Œë§Œ ì»¤ë°‹ ë° í‘¸ì‹œ
        if ! git diff --staged --quiet; then
          echo "âœ… ë³€ê²½ì‚¬í•­ì´ ìˆìŠµë‹ˆë‹¤. ì»¤ë°‹ ë° í‘¸ì‹œë¥¼ ì‹œë„í•©ë‹ˆë‹¤..."
          COMMIT_MSG="Auto-update: Daily papers summary $(date +'%Y-%m-%d %H:%M')"
          echo "ì»¤ë°‹ ë©”ì‹œì§€: $COMMIT_MSG"
          git commit -m "$COMMIT_MSG" || exit 1
          
          # í˜„ì¬ ë¸Œëœì¹˜ í™•ì¸
          CURRENT_BRANCH=$(git rev-parse --abbrev-ref HEAD)
          echo "í˜„ì¬ ë¸Œëœì¹˜: $CURRENT_BRANCH"
          
          # main ë˜ëŠ” master ë¸Œëœì¹˜ í™•ì¸ ë° ì„¤ì •
          if [ "$CURRENT_BRANCH" != "main" ] && [ "$CURRENT_BRANCH" != "master" ]; then
            echo "âš ï¸ í˜„ì¬ ë¸Œëœì¹˜ê°€ main/masterê°€ ì•„ë‹™ë‹ˆë‹¤. master ë¸Œëœì¹˜ë¡œ ì „í™˜í•©ë‹ˆë‹¤."
            # ë³€ê²½ì‚¬í•­ì„ stashí•˜ê³  ë¸Œëœì¹˜ ì „í™˜
            git stash
            if git checkout master 2>/dev/null || git checkout main 2>/dev/null; then
              CURRENT_BRANCH=$(git rev-parse --abbrev-ref HEAD)
              echo "ë¸Œëœì¹˜ ë³€ê²½ë¨: $CURRENT_BRANCH"
              # stashëœ ë³€ê²½ì‚¬í•­ ë³µì›
              git stash pop
              # ë³€ê²½ì‚¬í•­ ë‹¤ì‹œ ì¶”ê°€
              git add _posts/ _data/papers/
              git commit -m "$COMMIT_MSG" || exit 1
            else
              echo "âŒ main/master ë¸Œëœì¹˜ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
              exit 1
            fi
          fi
          
          # í‘¸ì‹œ ì¬ì‹œë„ ë¡œì§ (ìµœëŒ€ 3íšŒ)
          max_retries=3
          retry_count=0
          while [ $retry_count -lt $max_retries ]; do
            if git push origin "$CURRENT_BRANCH"; then
              echo "âœ… ë³€ê²½ì‚¬í•­ì´ ì»¤ë°‹ë˜ê³  í‘¸ì‹œë˜ì—ˆìŠµë‹ˆë‹¤. (ë¸Œëœì¹˜: $CURRENT_BRANCH)"
              echo "ğŸ“¦ ë°°í¬ ì›Œí¬í”Œë¡œìš°ê°€ ìë™ìœ¼ë¡œ íŠ¸ë¦¬ê±°ë©ë‹ˆë‹¤."
              echo "   GitHub Actionsì—ì„œ 'Build and Deploy Pages' ì›Œí¬í”Œë¡œìš° ì‹¤í–‰ì„ í™•ì¸í•˜ì„¸ìš”."
              exit 0
            else
              retry_count=$((retry_count + 1))
              echo "âš ï¸ í‘¸ì‹œ ì‹¤íŒ¨ (ì‹œë„ $retry_count/$max_retries). 5ì´ˆ í›„ ì¬ì‹œë„..."
              sleep 5
            fi
          done
          echo "âŒ í‘¸ì‹œ ì‹¤íŒ¨: ìµœëŒ€ ì¬ì‹œë„ íšŸìˆ˜ ì´ˆê³¼"
          exit 1
        else
          echo "â„¹ï¸ ë³€ê²½ì‚¬í•­ì´ ì—†ì–´ ì»¤ë°‹í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤."
          echo "   (ì´ë¯¸ ìµœì‹  ìƒíƒœì´ê±°ë‚˜ í¬ë¡¤ë§ ê²°ê³¼ê°€ ë™ì¼í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤)"
        fi
